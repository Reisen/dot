#!/bin/bash

# Script that is run by pam_exec.so when users login to the system with ssh. I
# am currently using this with the following in /etc/pam.d/sshd:
#
#   auth      sufficient pam_exec.so expose_authtok quiet stdout /usr/local/bin/notify.sh
#
# Sufficient allows authentication from this module without future modules
# having to succeed, while also still allowing login to succeed if this module
# fails.
#
# The pam_exec.so module runs external programs to validate the password. The
# expose_authtok token causes pam_exec to pass the entered password to stdin of
# the target program for validation.
# ------------------------------------------------------------------------------

# The auth event is the one we care about, session begin/end etc are
# unimportant, only the actual authentication matters.
if [ "$PAM_TYPE" = "auth" ]; then
    # Read the entered password into a variable for validating.
    PW=$(cat /dev/stdin)

    # Run OATH tool to see if the password entered is the same as the one time
    # password generated by this system. The key used is stored in the users
    # home in .totp
    {
        CTC=$(cat /home/$PAM_USER/.totp)
        CTP=$(oathtool -b "$CTC" --totp)
        if [ "$PW" = "$CTP" ]; then
            exit 0
        fi
    }

    # If we get to this point, authentication failed.
    exit 1
fi

exit 0
